const i=document.getElementById("connectionDot"),d=document.getElementById("connectionStatus"),S=document.getElementById("pageDot"),v=document.getElementById("pageStatus"),y=document.getElementById("errorMessage"),I=document.getElementById("successMessage"),P=document.getElementById("resultSummary"),T=document.getElementById("progressSection"),B=document.getElementById("progressFill"),b=document.getElementById("progressText"),k=document.getElementById("syncBtn"),l=document.getElementById("syncBtnText"),A=document.getElementById("syncSpinner"),x=document.getElementById("viewInChuckbox"),L=document.getElementById("infoText"),n=document.getElementById("tokenInput"),g=document.getElementById("clearTokenBtn");let m=!1,o=!1,f=null;document.addEventListener("DOMContentLoaded",async()=>{await w(),await M(),(await chrome.runtime.sendMessage({action:"getStatus"})).hasToken&&(n.value="••••••••••••••••",n.disabled=!0,g.classList.remove("hidden")),n.addEventListener("change",D),g.addEventListener("click",G),k.addEventListener("click",O)});async function w(){try{(await chrome.runtime.sendMessage({action:"checkAuth"})).authenticated?(i.className="status-dot green",d.textContent="Connected",o=!0):(await chrome.runtime.sendMessage({action:"getStatus"})).hasToken?(i.className="status-dot yellow",d.textContent="Token Set",o=!0):(i.className="status-dot red",d.textContent="Not Connected",o=!1)}catch{i.className="status-dot red",d.textContent="Error",o=!1}N()}async function M(){var t;try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id)){r("No active tab");return}if(f=e.id,!((t=e.url)!=null&&t.includes("advancements.scouting.org"))){r("Not on Scoutbook");return}try{(await chrome.tabs.sendMessage(e.id,{action:"ping"})).isRosterPage?(S.className="status-dot green",v.textContent="Ready",m=!0,L.textContent='Click "Sync Roster" to import your roster to Chuckbox.'):r("Navigate to roster")}catch{r("Loading..."),setTimeout(M,1e3)}}catch{r("Error")}N()}function r(t){S.className="status-dot gray",v.textContent=t,m=!1,L.textContent="Navigate to your Scoutbook roster page to enable sync."}function N(){const t=m&&o;k.disabled=!t,t?l.textContent="Sync Roster":o?m||(l.textContent="Go to Roster Page"):l.textContent="Set Token First"}async function D(){const t=n.value.trim();if(!(!t||t.includes("•")))try{await chrome.runtime.sendMessage({action:"setToken",token:t}),n.value="••••••••••••••••",n.disabled=!0,g.classList.remove("hidden"),C("Token saved successfully"),await w()}catch{h("Failed to save token")}}async function G(){try{await chrome.runtime.sendMessage({action:"setToken",token:""}),n.value="",n.disabled=!1,n.focus(),g.classList.add("hidden"),await w()}catch{h("Failed to clear token")}}async function O(){if(!f){h("No active tab");return}z(),H(),j("Extracting roster data...",10),E(!0);try{u("Navigating to first page...",15);const t=await chrome.tabs.sendMessage(f,{action:"extract"});if(!t.success)throw new Error(t.error||"Failed to extract roster");const e=(t.html.match(/<!-- PAGE BREAK -->/gi)||[]).length+1;u(`Extracted ${e} page(s). Processing with AI...`,30);let a=30;const U=setInterval(()=>{a<90&&(a+=.5,u(`Analyzing roster with AI (page ${Math.min(Math.ceil((a-30)/(60/e)),e)} of ${e})...`,Math.round(a)))},500),p=await chrome.runtime.sendMessage({action:"sync",html:t.html});if(clearInterval(U),!p.success)throw new Error(p.error||"Sync failed");u("Complete!",100);const{staging:s}=p,R=s.toCreate+s.toUpdate+s.adultsToCreate+s.adultsToUpdate,$=((await chrome.runtime.sendMessage({action:"getStatus"})).apiUrl||"https://chuckbox.app/api").replace("/api","");if(R===0)C("Roster is up to date - no changes needed.");else{const c=[];s.toCreate>0&&c.push(`${s.toCreate} new scouts`),s.toUpdate>0&&c.push(`${s.toUpdate} scout updates`),s.adultsToCreate>0&&c.push(`${s.adultsToCreate} new adults`),s.adultsToUpdate>0&&c.push(`${s.adultsToUpdate} adult updates`),C(`Found: <strong>${c.join(", ")}</strong><br><a href="${$}/settings" target="_blank" class="link">Review in Chuckbox</a>`)}const F=((await chrome.runtime.sendMessage({action:"getStatus"})).apiUrl||"https://chuckbox.app/api").replace("/api","");x.href=`${F}/settings`,x.classList.remove("hidden")}catch(t){h(t instanceof Error?t.message:"Sync failed")}finally{E(!1),q()}}function E(t){k.disabled=t,l.textContent=t?"Syncing...":"Sync Roster",A.classList.toggle("hidden",!t)}function j(t,e){T.classList.remove("hidden"),B.style.width=`${e}%`,b.textContent=t}function u(t,e){B.style.width=`${e}%`,b.textContent=t}function q(){setTimeout(()=>{T.classList.add("hidden")},1e3)}function h(t){y.textContent=t,y.classList.remove("hidden")}function z(){y.classList.add("hidden")}function C(t){P.innerHTML=t,I.classList.remove("hidden")}function H(){I.classList.add("hidden")}
