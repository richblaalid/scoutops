const i=document.getElementById("connectionDot"),d=document.getElementById("connectionStatus"),S=document.getElementById("pageDot"),v=document.getElementById("pageStatus"),y=document.getElementById("errorMessage"),T=document.getElementById("successMessage"),$=document.getElementById("resultSummary"),B=document.getElementById("progressSection"),I=document.getElementById("progressFill"),b=document.getElementById("progressText"),k=document.getElementById("syncBtn"),l=document.getElementById("syncBtnText"),D=document.getElementById("syncSpinner"),E=document.getElementById("viewInChuckbox"),L=document.getElementById("infoText"),n=document.getElementById("tokenInput"),g=document.getElementById("clearTokenBtn");let m=!1,o=!1,f=null;document.addEventListener("DOMContentLoaded",async()=>{await x(),await M(),(await chrome.runtime.sendMessage({action:"getStatus"})).hasToken&&(n.value="••••••••••••••••",n.disabled=!0,g.classList.remove("hidden")),n.addEventListener("change",A),g.addEventListener("click",G),k.addEventListener("click",O)});async function x(){try{(await chrome.runtime.sendMessage({action:"checkAuth"})).authenticated?(i.className="status-dot green",d.textContent="Connected",o=!0):(await chrome.runtime.sendMessage({action:"getStatus"})).hasToken?(i.className="status-dot yellow",d.textContent="Token Set",o=!0):(i.className="status-dot red",d.textContent="Not Connected",o=!1)}catch{i.className="status-dot red",d.textContent="Error",o=!1}N()}async function M(){var t;try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id)){c("No active tab");return}if(f=e.id,!((t=e.url)!=null&&t.includes("advancements.scouting.org"))){c("Not on Scoutbook");return}try{(await chrome.tabs.sendMessage(e.id,{action:"ping"})).isRosterPage?(S.className="status-dot green",v.textContent="Ready",m=!0,L.textContent='Click "Sync Roster" to import your roster to Chuckbox.'):c("Navigate to roster")}catch{c("Loading..."),setTimeout(M,1e3)}}catch{c("Error")}N()}function c(t){S.className="status-dot gray",v.textContent=t,m=!1,L.textContent="Navigate to your Scoutbook roster page to enable sync."}function N(){const t=m&&o;k.disabled=!t,t?l.textContent="Sync Roster":o?m||(l.textContent="Go to Roster Page"):l.textContent="Set Token First"}async function A(){const t=n.value.trim();if(!(!t||t.includes("•")))try{await chrome.runtime.sendMessage({action:"setToken",token:t}),n.value="••••••••••••••••",n.disabled=!0,g.classList.remove("hidden"),C("Token saved successfully"),await x()}catch{h("Failed to save token")}}async function G(){try{await chrome.runtime.sendMessage({action:"setToken",token:""}),n.value="",n.disabled=!1,n.focus(),g.classList.add("hidden"),await x()}catch{h("Failed to clear token")}}async function O(){if(!f){h("No active tab");return}H(),K(),j("Extracting roster data...",10),w(!0);try{u("Navigating to first page...",15);const t=await chrome.tabs.sendMessage(f,{action:"extract"});if(!t.success)throw new Error(t.error||"Failed to extract roster");const e=(t.html.match(/<!-- PAGE BREAK -->/gi)||[]).length+1;u(`Extracted ${e} page(s). Processing...`,30);let r=30;const U=setInterval(()=>{r<90&&(r+=2,u("Processing roster data...",Math.round(r)))},200),p=await chrome.runtime.sendMessage({action:"sync",html:t.html});if(clearInterval(U),!p.success)throw new Error(p.error||"Sync failed");u("Complete!",100);const{staging:s}=p,R=s.toCreate+s.toUpdate+s.adultsToCreate+s.adultsToUpdate,P=((await chrome.runtime.sendMessage({action:"getStatus"})).apiUrl||"https://chuckbox.app/api").replace("/api","");if(R===0)C("Roster is up to date - no changes needed.");else{const a=[];s.toCreate>0&&a.push(`${s.toCreate} new scouts`),s.toUpdate>0&&a.push(`${s.toUpdate} scout updates`),s.adultsToCreate>0&&a.push(`${s.adultsToCreate} new adults`),s.adultsToUpdate>0&&a.push(`${s.adultsToUpdate} adult updates`),C(`Found: <strong>${a.join(", ")}</strong><br><a href="${P}/settings" target="_blank" class="link">Review in Chuckbox</a>`)}const F=((await chrome.runtime.sendMessage({action:"getStatus"})).apiUrl||"https://chuckbox.app/api").replace("/api","");E.href=`${F}/settings`,E.classList.remove("hidden")}catch(t){h(t instanceof Error?t.message:"Sync failed")}finally{w(!1),q()}}function w(t){k.disabled=t,l.textContent=t?"Syncing...":"Sync Roster",D.classList.toggle("hidden",!t)}function j(t,e){B.classList.remove("hidden"),I.style.width=`${e}%`,b.textContent=t}function u(t,e){I.style.width=`${e}%`,b.textContent=t}function q(){setTimeout(()=>{B.classList.add("hidden")},1e3)}function h(t){y.textContent=t,y.classList.remove("hidden")}function H(){y.classList.add("hidden")}function C(t){$.innerHTML=t,T.classList.remove("hidden")}function K(){T.classList.add("hidden")}
