document.getElementById("headerSubtitle");const T=document.getElementById("unitCard"),q=document.getElementById("unitName"),v=document.getElementById("notConnectedCard"),K=document.getElementById("connectionStatus"),I=document.getElementById("pageDot"),B=document.getElementById("pageStatus"),p=document.getElementById("errorMessage"),M=document.getElementById("successMessage"),V=document.getElementById("resultSummary"),L=document.getElementById("progressSection"),N=document.getElementById("progressFill"),R=document.getElementById("progressText"),f=document.getElementById("syncBtn"),u=document.getElementById("syncBtnText"),W=document.getElementById("syncSpinner"),w=document.getElementById("viewInChuckbox"),P=document.getElementById("infoText"),s=document.getElementById("tokenInput"),b=document.getElementById("tokenSpinner"),C=document.getElementById("clearTokenBtn"),U=document.getElementById("tokenInfoText");let l=!1,g=!1,i=null;document.addEventListener("DOMContentLoaded",async()=>{await $(),await z(),s.addEventListener("input",S),s.addEventListener("paste",()=>{setTimeout(S,50)}),C.addEventListener("click",Q),f.addEventListener("click",X)});async function $(){try{const e=await chrome.runtime.sendMessage({action:"checkAuth"});e.authenticated&&e.unitName?F(e.unitName):(await chrome.runtime.sendMessage({action:"getStatus"})).hasToken?c("Token invalid or expired"):c("Not Connected")}catch{c("Connection Error")}k()}function F(e){g=!0,T.style.display="block",v.style.display="none",q.textContent=e,s.value="••••••••••••••••",s.disabled=!0,C.classList.remove("hidden"),U.innerHTML=`Connected to <strong>${e}</strong>`}function c(e){g=!1,T.style.display="none",v.style.display="block",K.textContent=e,s.value="",s.disabled=!1,C.classList.add("hidden"),U.innerHTML='Get a token from <a href="https://chuckbox.app/settings/integrations" target="_blank" class="link">Chuckbox Settings</a>'}async function z(){var e;try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t!=null&&t.id)){d("No active tab");return}if(i=t.id,!((e=t.url)!=null&&e.includes("advancements.scouting.org"))){d("Not on Scoutbook");return}await J(t.id)?(I.className="status-dot green",B.textContent="Ready",l=!0,P.textContent='Click "Sync Roster" to import your roster to Chuckbox.'):d("Unable to connect")}catch{d("Error")}k()}async function J(e){try{return await chrome.tabs.sendMessage(e,{action:"ping"}),!0}catch{console.log("[Chuckbox] Content script not found, injecting...")}try{await chrome.scripting.executeScript({target:{tabId:e},files:["content.js"]}),console.log("[Chuckbox] Content script injected successfully"),await new Promise(t=>setTimeout(t,200));try{return await chrome.tabs.sendMessage(e,{action:"ping"}),!0}catch{return console.error("[Chuckbox] Content script injected but not responding"),!1}}catch(t){return console.error("[Chuckbox] Failed to inject content script:",t),!1}}function d(e){I.className="status-dot gray",B.textContent=e,l=!1,P.textContent="Navigate to your Scoutbook roster page to enable sync."}function k(){const e=l&&g;f.disabled=!e,e?u.textContent="Sync Roster":g?l||(u.textContent="Go to Roster Page"):u.textContent="Set Token First"}async function S(){const e=s.value.trim();if(!(!e||e.includes("•")||e.length<20)){b.classList.remove("hidden"),s.disabled=!0,j();try{await chrome.runtime.sendMessage({action:"setToken",token:e});const t=await chrome.runtime.sendMessage({action:"checkAuth"});t.authenticated&&t.unitName?(F(t.unitName),y(`Connected to ${t.unitName}`)):(c("Token invalid or expired"),a("Token is invalid or expired. Generate a new one in Chuckbox Settings."),await chrome.runtime.sendMessage({action:"setToken",token:""}))}catch{a("Failed to validate token. Check your connection."),c("Connection Error")}finally{b.classList.add("hidden"),k()}}}async function Q(){try{await chrome.runtime.sendMessage({action:"setToken",token:""}),c("Not Connected"),s.focus(),G(),await $()}catch{a("Failed to disconnect")}}async function X(){if(!i){a("No active tab");return}j(),G(),Y("Preparing...",5),E(!0);try{if(!(await chrome.tabs.sendMessage(i,{action:"ping"})).isRosterPage){r("Navigating to roster...",10);const o=await chrome.tabs.sendMessage(i,{action:"navigateToRoster"});if(!o.success)throw new Error(o.error||"Could not navigate to roster page");await new Promise(_=>setTimeout(_,1e3))}r("Extracting roster data...",15);const t=await chrome.tabs.sendMessage(i,{action:"extract"});if(!t.success)throw new Error(t.error||"Failed to extract roster");const x=(t.html.match(/<!-- PAGE BREAK -->/gi)||[]).length+1;r(`Extracted ${x} page(s). Processing...`,30);let m=30;const A=setInterval(()=>{m<90&&(m+=2,r("Processing roster data...",Math.round(m)))},200),h=await chrome.runtime.sendMessage({action:"sync",html:t.html});if(clearInterval(A),!h.success)throw new Error(h.error||"Sync failed");r("Complete!",100);const{staging:n}=h,H=n.toCreate+n.toUpdate+n.adultsToCreate+n.adultsToUpdate,O=((await chrome.runtime.sendMessage({action:"getStatus"})).apiUrl||"https://chuckbox.app/api").replace("/api","");if(H===0)y("Roster is up to date - no changes needed.");else{const o=[];n.toCreate>0&&o.push(`${n.toCreate} new scouts`),n.toUpdate>0&&o.push(`${n.toUpdate} scout updates`),n.adultsToCreate>0&&o.push(`${n.adultsToCreate} new adults`),n.adultsToUpdate>0&&o.push(`${n.adultsToUpdate} adult updates`),y(`<strong>Sync complete!</strong><br>${o.join(", ")}<br><br><a href="${O}/settings/integrations" target="_blank" class="link" style="font-weight: 500;">Review changes in Chuckbox →</a>`)}const D=((await chrome.runtime.sendMessage({action:"getStatus"})).apiUrl||"https://chuckbox.app/api").replace("/api","");w.href=`${D}/settings/integrations`,w.classList.remove("hidden")}catch(e){const t=e instanceof Error?e.message:"Sync failed";t.includes("Rate limit")?a("Too many syncs. Please wait an hour before syncing again."):t.includes("Invalid")||t.includes("expired")?a("Token is invalid or expired. Generate a new one in Chuckbox Settings."):t.includes("roster")?a("Navigate to your Scoutbook roster page, then click Sync."):a(t)}finally{E(!1),Z()}}function E(e){f.disabled=e,u.textContent=e?"Syncing...":"Sync Roster",W.classList.toggle("hidden",!e)}function Y(e,t){L.classList.remove("hidden"),N.style.width=`${t}%`,R.textContent=e}function r(e,t){N.style.width=`${t}%`,R.textContent=e}function Z(){setTimeout(()=>{L.classList.add("hidden")},1e3)}function a(e){p.textContent=e,p.classList.remove("hidden")}function j(){p.classList.add("hidden")}function y(e){V.innerHTML=e,M.classList.remove("hidden")}function G(){M.classList.add("hidden")}
