const h="https://chuckbox.app/api",l="http://localhost:3000/api";class d{constructor(e=!1){this.token=null,this.baseUrl=e?l:h}setToken(e){this.token=e}setBaseUrl(e){this.baseUrl=e.replace(/\/$/,"")}async request(e,a={}){const c=`${this.baseUrl}${e}`,r={"Content-Type":"application/json",...a.headers};this.token&&(r.Authorization=`Bearer ${this.token}`);const o=await fetch(c,{...a,headers:r,mode:"cors"}),i=await o.json();if(!o.ok){const u=i;throw new Error(u.error||"Request failed")}return i}async syncRoster(e){return this.request("/scoutbook/extension-sync",{method:"POST",body:JSON.stringify({html:e})})}async checkSession(){try{const e=await this.request("/scoutbook/extension-auth",{method:"GET"});return{authenticated:!0}}catch{return{authenticated:!1}}}async generateToken(){return this.request("/scoutbook/extension-auth",{method:"POST"})}}const n=new d,s={TOKEN:"chuckbox_token",API_URL:"chuckbox_api_url",LAST_SYNC:"chuckbox_last_sync"};async function k(){const t=await chrome.storage.local.get([s.TOKEN,s.API_URL]);t[s.TOKEN]&&n.setToken(t[s.TOKEN]),t[s.API_URL]&&n.setBaseUrl(t[s.API_URL])}k();chrome.runtime.onMessage.addListener((t,e,a)=>(g(t).then(a).catch(c=>{a({success:!1,error:c instanceof Error?c.message:"Unknown error"})}),!0));async function g(t){switch(t.action){case"sync":return y(t.html);case"checkAuth":return b();case"setToken":return S(t.token);case"setApiUrl":return T(t.url);case"getStatus":return f();default:throw new Error("Unknown action")}}async function y(t){try{const e=await n.syncRoster(t);return await chrome.storage.local.set({[s.LAST_SYNC]:{timestamp:new Date().toISOString(),sessionId:e.sessionId,staging:e.staging}}),{success:!0,...e}}catch(e){throw e}}async function b(){try{const t=await n.checkSession();return{success:!0,authenticated:t.authenticated,unitName:t.unitName}}catch{return{success:!1,authenticated:!1}}}async function S(t){return n.setToken(t),await chrome.storage.local.set({[s.TOKEN]:t}),{success:!0}}async function T(t){return n.setBaseUrl(t),await chrome.storage.local.set({[s.API_URL]:t}),{success:!0}}async function f(){const t=await chrome.storage.local.get([s.TOKEN,s.API_URL,s.LAST_SYNC]);return{hasToken:!!t[s.TOKEN],apiUrl:t[s.API_URL]||"https://chuckbox.app/api",lastSync:t[s.LAST_SYNC]}}chrome.runtime.onMessage.addListener((t,e)=>{var a;t.action==="pageReady"&&t.isRosterPage&&(a=e.tab)!=null&&a.id&&(chrome.action.setBadgeText({text:"!",tabId:e.tab.id}),chrome.action.setBadgeBackgroundColor({color:"#059669",tabId:e.tab.id}))});chrome.tabs.onActivated.addListener(async t=>{try{const e=await chrome.tabs.get(t.tabId);e.url&&!e.url.includes("advancements.scouting.org")&&chrome.action.setBadgeText({text:"",tabId:t.tabId})}catch{}});console.log("[Chuckbox] Background service worker loaded");
